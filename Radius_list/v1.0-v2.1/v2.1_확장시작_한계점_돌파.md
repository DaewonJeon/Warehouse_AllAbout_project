## 구글의 전세계 데이터 건드려보기 (OpenStreetMap(OSM) 공개 데이터)

1. Step 1. 구글 클라우드 콘솔 접속 (무료 샌드박스)

> Google Cloud Console에 접속합니다. (구글 아이디만 있으면 됩니다)

- 프로젝트를 하나 생성합니다 (My project)

카드 등록을 안 해도 Sandbox 모드로 일정량 무료 쿼리가 가능한 상황

- **구글 빅쿼리 테스트**
```
SELECT COUNT(*) 
FROM `bigquery-public-data.geo_openstreetmap.planet_features`;
```
웹에서 실행했을때 **결과나오면 바로 빅쿼리 API 활성화** 된 것입니다

> 전 세계 공간 데이터를 내 DB로 끌어오는 파이프라인을 만들어본다!

2. Step 2. "서울시 모든 카페" 쿼리 보내보기
콘솔 중앙의 **[쿼리 편집기]**에 아래 SQL을 복사해서 붙여넣고 실행(Run) 버튼을 누르기 (이 테이블은 전 세계 데이터를 다 가지고 있어서 planet_features라고 부릅니다)

SQL
```
SELECT
  osm_id,
  (
    SELECT value
    FROM UNNEST(all_tags)
    WHERE key = 'name'
    LIMIT 1
  ) AS name,
  geometry
FROM `bigquery-public-data.geo_openstreetmap.planet_features`
WHERE
  ('amenity', 'cafe') IN (
    SELECT AS STRUCT key, value FROM UNNEST(all_tags)
  )
  AND ST_INTERSECTSBOX(
    geometry,
    126.7, 37.4,
    127.3, 37.7
  )
LIMIT 100;
```
> name 으로만 쓰고싶지만, name이라는 최상위 컬럼이 존재하지 않는다 그러므로 all_tag로 뽑아준다
> OSM 데이터에서 이름은 보통: all_tags (key-value 배열) 안에 ("name", "스타벅스") 같은 형태로 들어있다

- **결과: 순식간에 서울/경기권 카페 100개의 ID, 이름, 좌표가 뜹니다.**
**+구글은 시각화로 지도에서 바로 표현가능**

느낀점 : "와, API 루프 안 돌려도 데이터가 그냥 있네?"

**geometry 컬럼 설명**

- Geometry에 들어있는 것

> POINT / POLYGON / LINESTRING 로 되어있다
> POINT → 단일 좌표 (대부분 카페)
> POLYGON → 건물 전체 면적
> LINESTRING → 길쭉한 구조물

---

### 직면한 문제!

- 현재 구조인 Django / PostGIS에 바로 넣기 어려움

- 중심점(CENTROID) 을 뽑아야 할 것 같다

---
```
1️⃣ web 컨테이너 접속
docker-compose exec web bash

2️⃣ 설치
pip install google-cloud-bigquery db-dtypes

3️⃣ requirements.txt 다시 생성
pip freeze > requirements.txt

4️⃣ 확인
grep google requirements.txt

4번 하면 
google-api-core==2.28.1
google-auth==2.45.0
google-cloud-bigquery==3.39.0
google-cloud-core==2.5.0
google-crc32c==1.8.0
google-resumable-media==2.8.0
googleapis-common-protos==1.72.0

이런식으로 나타난다
(과정 확인하도록)
```

---

## 구글 빅쿼리 (OSM 데이터의 문제점 직면)

- 쿼리 성능은 정말 뛰어나지만, OSM 데이터가 너무 없다..

> 데이터 많이 부족(서울 시내 다이소만 260개 정도 되는데, OSM 데이터는 60개 정도.)

**다시 카카오맵API 호출로 서울시 모든 다이소 불러오고, 각각 다이소를 바탕으로 1km 반경으로 편의점 및 카페 데이터를 가져왔습니다.**

**각각 저장된 데이터는 admin에서도 확인가능하고, DB를 통해 PostgreSQL(PostGIS)에 저장되었습니다**



---
